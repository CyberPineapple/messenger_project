# Спецификация 

В данном релизе бекэнд содержит в себе следующий функционал:

* регистрация и авторизация пользователя;
* выход пользователя из системы;
* шифрование пароля;
* сессия пользователя;
* создание чата и чата с паролем;
* удаление чата;
* передача сообщений между пользователями.

## 1. Регистрация и авторизация пользователя

При регистрации к пользователю предъявляются следующие требования:
* длина логина не больше 20 символов;
* логин должен быть уникальным.

**(?)** А если больше 20 симоволов? *ограничить на фронтэнде*

### Регистрация

Для регистрации пользователя, клиент должен отправить следующий json-запрос

```
  "Type": "registration",
  "Login": "user",
  "Password": "password"
```

Сервер ответит

```
  "Type": "registration",                                            
  "Status": "success"
```

### Зарегистрированный пользователь

Если пользователь попробует зарегистрироваться под уже имеющимся в базе логином, то сервер ответит так

```
  "Type": "registration",
  "Status": "user exist"
```

***FAQ***

*Нужно ли авторизовываться после регистрации?* 
Нет, не нужно. Однако стоит проверить этот факт.

### Авторизация

Для авторизации пользователя клиент должен отправить следующий json-запрос

```
  "Type": "login",
  "Login": "user",
  "Password": "password"
```

Сервер ответит

```
  "Type": "login",
  "Status": "success"
```

### Неверный пароль или несуществующий пользователь
Если пользователь введет неверный пароль или логин не существует в базе, сервер ответит ему так

```
  "Type": "login",
  "Status": "error"
```

## 2. Выход пользователя из системы
Чтобы совершить выход из системы, клиент должен отправить на сервер

```
  "Type": "logout",                                                   
  "Login": "user"
```

Сервер ответит

```
  "Type": "logout", 
  "Status": "success"
```

**(?)** Однако стоит задуматься, нужно ли вообще серверу отправлять ответ?

### Выход не авторизованного пользователя
Если пользователь не имеющий логина и не авторизованный в системе отправит запрос на выход, сервер ответит так

```
  "Type": "logout", 
  "Status": "error"
```

## 3. Шифрование паролей
Пользователь может быть спокоен, все пароли хранятся в sha-512 + salt(sha256 + random) 

**(?)** Добавить хранение от чата пароля в хеше

## 4. Сессия пользователя
Сессия пользователя автоматически создаётся при входе или регистрации пользователя. Сессия хранит идентификатор пользователя и время входа в систему и текущий чат.

## 5. Чат
При создании чата перед пользователем предъявляются следующие требования:
* длина имени чата не должна превышать 32 символов;
* пользователь должен быть авторизован в системе.

### Создание 
Для создания чата клиент должен отправить json-запрос с следущим содержанием

```
  "Type": "chat",                                                    
  "Command": "create"                                                     
  "Chat": "general"
```

При успешном создании чата сервер ответит

```
  "Type": "chat", 
  "Status": "success"
```

Если не авторизованный пользователь попробует создать чат, сервер ответит ему так

```
  "Type": "login", 
  "Status": "error"
```

### Создание чата с паролем
Для создания чата с паролем необходимо добавить еще одно поле Password, для установки пароля.

```
  "Type": "chat",                                                     
  "Command": "create"                                                     
  "Chat": "general secret"
  "Password": "secret"

```
При успешном создании чата с паролем сервер ответит

```
  "Type": "chat",  
  "Status": "success"

```
Если пользователь создат чат с уже имеющимся именем в базе, сервер ответит
```
   "Type": "chat",
   "Status": "chat exist"
```
### Удаление чата
Для удаления чата необходимы следующие условия условие

* пользователь должнен быть создателем чата
* пользователь должен выбрать чат ("Command": "choice")

Удаление чата как **с паролем**, так **без** приходит **без изменений**.

Для удаления пользователь должен отправить следующий json запрос

```
   "Type": "chat",                                                         
   "Command": "delete"
```

При успешном запросе сервер ответит

```
  "Type": "chat",                                                                                 
  "Command": "delete",
  "Status": "success"
```

Если попытается удалить не создатель чата, сервер ответит так

```
  "Type": "chat",
  "Command": "delete",
  "Status": "error"
```


### Вход в чат под паролем
Для входа в чат с паролем нужно отправить серверу

```
  'Type': 'chat', 
  'Command': 'choice', 
  'Chat': 'secret general', 
  'Password': 'secret'
```

При вверно введеном пароле сервер ответит

```
  "Type": "chat",
  "Messages": [
   {
    "user": "user", 
    "text": "Встретимся на остановке", 
    "date": "2019-01-01 03:59:00"
   }, 
  ]
```

Где **Messages** это массив с json объектам.

Если пользователь захочет посмотреть одим глазком в закрытый чат, не имея пароля

```
  "Type":"chat",                                                     
  "Command":"choice",                                                
  "Chat":"secret general"                                                        
```

Сервер лишь помахает пальцем

```
  "Type": "chat",
  "Status": "access denied"
```

Или пользователь забыл пароль

```
  "Type":"chat",                                                   
  "Command":"choice",                                             
  "Chat":"secret general",                                        
  "Password": "terces"
```

Сервер ответит аналогично

```
  "Type": "chat",
  "Status": "access denied"
```

### Получить список чатов
Для получения всех чатов пользователя нужно отправить

```
  "Type": "chat",
  "Command": "list"
```

Сервер ответит

```
  "Type": "chat",
  "Chats": [
   {
    "Chat": "general",
    "Closed": false
    },
    {
    "Chat": "secret general",
    "Closed": true
    }
  ]
```

В поле Chats **все** чаты системы. В поле Chat находится имя чата, поле Closed - признак чата под паролем чата. True - пароль есть.

Если не авторизованный пользователь попытается получить чаты, то сервер ответит 

```
  "Type": "login", 
  "Status": "error"
```

### Получить сообщения из чата

Для получения сообщений из чата клиент должен отправить

```
  "Type": "chat",
  "Chat": "general",
  "Command": "choice"
```

Сервер ответит

```
  "Type": "chat", 
  "Command": "choice",
  "Messages": [
  {
    "user": "user", 
    "text": "Hello from past", 
    "date": "1970-01-03 03:59:00"
  }, 
  {
    "user": "user",
    "text": "Hey, there is somebody?", 
    "date": "2019-05-04 20:00:00"
  }
 ]
```

### Получить более ранние сообщения

По умолчанию сервер отдает последние 15 сообщений, чтобы избежать нагрузки на сервер. 

Если клиенту нужно получить раннее отправленные сообщения, то нужно отправить

```
"Type": "chat",
"Command": "earlier"
```

На что сервер ответ 

```
 "Type": "chat", 
  "Command": "earlier",
  "Messages": [
  {
    "user": "login", 
    "text": "Hello from past", 
    "date": "1970-01-03 03:59:00"
  }, 
  {
    "user": "user",
    "text": "Hey, there is somebody?", 
    "date": "2019-05-04 20:00:00"
  }
 ]
```

Если клиент достиг ~~дна~~ начала переписки, сервер отправит 

```
 "Type": "chat", 
  "Command": "earlier",
  "Messages": [] 
```


## 6. Сообщения
Перед отправкой сообщения пользователь должен быть:
* авторизован;
* чат должен существовать.

Прежде чем отправить сообщение пользователь должен выбрать чат.

```
  "Type": "chat",
  "Chat": "general",
  "Command": "choice"
```
Только после пользователь может приступать к отправке сообщения.

Для отправки сообщения в чат клиент должен отправить сообщение 

```
  "Type": "chat",                                                  
  "Command": "message",
  "Text": "Hey, there is somebody?"
```

На что сервер ответит, точно таким же сообщением каждому подключенному пользователю

```
  "Type": "chat",                                                  
  "Command": "message",
  "Message": {
    "user" : "user",                                                                                                     
    "text": "Hey, there is somebody?",
    "date" : "2019-05-01T00:00:00"
  }
```

**Почему так?** Это происходит потому что, все общение идет через сервер. А значит мы должны отправлять только те сообщения которые гарантированно дошли до сервера и сохранены в базе.

Если пользователь попрообует отправить сообщение не авторизованныем или не выбрав чат, сервер ответит

```
  "Type": "chat",
  "Command": "message",                                   
  "Status": "error in chat or user"
```

**(?)** Обработать сообщение "Status": "error", например когда база недоступна или память кончилась, или сервер упал.

Если авторизованный пользователь попробует отправить в несуществующий чат сервер ему ответит

```
  "Type": "chat", 
  "Status": "error"
```

Так будет с каждым, кто дочитает спецификацию до конца.

Команда для создания базы данных с utf-8 кодировкой
create database Messenger with encoding='utf-8' LC_CTYPE='en_US.utf8' LC_COLLATE='en_US.utf8' TEMPLATE template0;
